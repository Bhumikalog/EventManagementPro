name: üöÄ CI/CD ‚Üí Sync resource-management to PES Tech repo

on:
  push:
    branches:
      - main
    paths:
      - 'src/components/resource-management/**'   # Trigger only when resource files change

jobs:
  sync-to-target:
    name: üîÑ Sync Resource Files
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout your source repository
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Configure git identity for commits
      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 3Ô∏è‚É£ Create a new temporary branch for syncing
      - name: Create branch for sync
        id: create_branch
        run: |
          BRANCH="sync-resources-${{ github.run_id }}"
          git checkout -b "$BRANCH"
          git add src/components/resource-management || true
          git commit -m "üîÑ Sync resource-management changes from ${{ github.repository }} @${{ github.sha }}" || echo "‚ö†Ô∏è No changes to commit"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Push branch to the target repository using PAT
      - name: Push changes to target repository
        run: |
          TARGET_REPO="pestechnology/PESU_RR_AIML_B_P82_Event_Management_System_Infinite-Loop"
          echo "üîó Adding target repository remote..."
          git remote add target "https://x-access-token:${{ secrets.TARGET_PAT }}@github.com/${TARGET_REPO}.git"
          echo "üöÄ Pushing branch to target repo..."
          git push target HEAD:refs/heads/${{ steps.create_branch.outputs.branch }} --force

      # 5Ô∏è‚É£ Create a Pull Request automatically in the target repo
      - name: Create Pull Request on target repo
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.TARGET_PAT }}
          script: |
            const targetOwner = 'pestechnology';
            const targetRepo = 'pestechnology/PESU_RR_AIML_B_P82_Event_Management_System_Infinite-Loop';
            const branchName = `sync-resources-${{ github.run_id }}`;
            const title = `üîÑ Sync: resource-management changes from ${process.env.GITHUB_REPOSITORY}`;
            const body = `This pull request was automatically generated by CI/CD.\n\nSource commit: ${{ github.sha }}\n\nChanges synced from: ${process.env.GITHUB_REPOSITORY}`;

            try {
              const { data: pr } = await github.rest.pulls.create({
                owner: targetOwner,
                repo: targetRepo,
                title,
                head: branchName,
                base: 'main',
                body
              });
              console.log(`‚úÖ Pull Request created: ${pr.html_url}`);
            } catch (error) {
              if (error.status === 422) {
                console.log("‚ö†Ô∏è PR already exists or no new changes to sync.");
              } else {
                throw error;
              }
            }
